<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="utf-8"/>
	<title>ESP8266 Clock</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<!-- build:js script.js -->
	<script src="/jquery/jq.min.js"></script>
<script>
$(document).on("mobileinit", function () {
	$.mobile.hashListeningEnabled = false;
    $.mobile.pushStateEnabled = false;
    $.mobile.changePage.defaults.changeHash = false;
});
</script>
	<script src="/jquery/m/1.4.5/jq.m.min.js"></script>
	<script src="/jquery/jq-sort.min.js"></script>
	<script src="/jquery/rs/1.3/rs.min.js"></script>
	<script src="/jquery/jq-tp.min.js"></script>
    <!-- endbuild -->

	<!-- build:css script.css -->
	<link rel="stylesheet" href="/jquery/m/1.4.5/jq.m.min.css" />
	<link href="/jquery/rs/1.3/rs.min.css" rel="stylesheet" />
	<!-- endbuild -->

	<link rel="shortcut icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAABFFBMVEUAAACSkpIxMTEKCgo/Pz9YWFgMDAwMDAwPDw8gICAqKipqamqSkpJ1dXUICAgGBgYQEBAEBAQNDQ0LCwsPDw8REREKCgoODg4TExMPDw8PDw8TExMdHR0SEhIVFRUiIiISEhISEhI5OTlHR0cXFxcbGxsXFxcbGxsbGxs2NjYfHx8pKSkwMDAzMzNKSkouLi5NTU1ZWVkqKipdXV1OTk5BQUEREREHBwcJCQkLCwscHBwVFRUrKyshISE4ODgUFBQgICAWFhYbGxsbGxsSEhIlJSUqKipNTU0WFhZbW1tSUlIiIiIbGxs7Ozs9PT1bW1sfHx8yMjJvb282NjZRUVEmJiZWVlZCQkJnZ2fw8PAAAAAKCgo+WiZ7AAAAWnRSTlMABDHtGgno2sdeQSEJBvn59vbx5OPa1MG/vrGuq6qmnZeQi4F9e3FuaGBaTko9OicjIB8ZEg3p59vLyb27t6mfl5GLhXZ0cGxqZmZkWFZQTko2LCooKBwUEATs1IN1AAAA/0lEQVQ4y4WQRXIDQRAEexakRTFLFjOjmZkZy///hxXhmzXTzksdMk9Ff5jMXFIiXNfr1B7o/VVIdV0HAlZvOwvsyIJi2nYO8UvIW/VaStBj/qKWgx75znytBk6FzvbM6vA4ON6MkAS/JO53x9XurVkGNFlhdO7E0CC6tBCekpp5cgDdZgL7JheaHZwIZVBqIE6kFfaf5b6fDCK2XG9Ccq6uY9CJJYCt/4IK6z+BJzZoI8v6j43oiPNmOtrj/NRKaYwWzUTTZ/woU18Qw1veIJbCnPeLRHnABkUAa6bavwBYFuqgAawDUL9wBLRbcZwqgxaCPonuuTIwwg7x9EnOD7yqJHNnrSJeAAAAAElFTkSuQmCC" />
	<style type="text/css">
/* Custom indentations are needed because the length of custom labels differs from
   the length of the standard labels */
.custom-label-flipswitch.ui-flipswitch .ui-btn.ui-flipswitch-on {
	text-indent: -3.4em;
}

.custom-label-flipswitch.ui-flipswitch .ui-flipswitch-off {
	text-indent: 0.5em;
}
/* Custom widths are needed because the length of custom labels differs from
   the length of the standard labels */
/*
.custom-label-flipswitch.ui-flipswitch {
    width: 8.875em;
}
.custom-label-flipswitch.ui-flipswitch.ui-flipswitch-active {
    padding-left: 7em;
    width: 1.875em;
}
@media (min-width: 28em) {
    // Repeated from rule .ui-flipswitch above
    .ui-field-contain > label + .custom-label-flipswitch.ui-flipswitch {
        width: 1.875em;
    }
}
*/
.headerText {
	opacity: 1 !important;
	background-color: #e9e9e9 !important;
}

.dispInline, .dispInlineLabel {
	display: inline-block;
	border-bottom-width: 0;
}

.dispInlineLabel {
	min-width: 150px;
	vertical-align: middle;
}

.dispInline {
	min-width: 150px;
	vertical-align: middle;
}

.clearFloats {
	clear: both;
}

.rs-control .rs-range-color {
	background: #3080c0;
}

.rs-control .rs-path-color {
	background-color: #e9e9e9;
}

.rs-control .rs-handle {
	background-color: #f6f6f6;
	border: 2px solid #d0d0d0;
}

.rs-tooltip-text {
	font-size: 16px;
}

.rs-tooltip.hover {
	background-color: #e9e9e9;
}

#digit .rs-seperator {
	border-width: 0px;
}

#digit .rs-handle {
	background-color: #3080c0;
}

#color-box {
	width: 32px;
	height: 32px;
	border: 1px solid grey;
	display: inline-block;
	vertical-align: top;
	margin-top: 10px;
	background-image: url(/assets/favicon-32x32.png);
	position: relative;
}

#color-overlay {
	width: 100%;
	height: 100%;
	z-index: 2;
}

#logo {
	position: absolute;
	top: 40px;
	right: 0;
	bottom: 0;
	left: 0;
	background: url(/assets/logo_m_gray.jpg?embed);
	background-repeat: no-repeat;
	background-size: 100%;
}
</style>
<script>
	var serverSetting = false;
	function updateElements(values) {
		serverSetting = true;
		var digit = values["digit"];
		if (typeof digit != 'undefined') {
			var range = $('#digit');
			range.roundSlider("setValue", digit, 1);
			delete values["digit"];
		}
		var displayOn = values["display_on"];
		if (typeof displayOn != 'undefined') {
			var range = $('#on_range')
			range.roundSlider("setValue", displayOn, 1);
			delete values["display_on"];
		}
		var displayOff = values["display_off"];
		if (typeof displayOff != 'undefined') {
			$('#on_range').roundSlider("setValue", displayOff, 2);
			delete values["display_off"];
		}
		var pinMap = values["pin_order"];
		if (typeof pinMap != 'undefined') {
			resetList(pinMap);
			delete values["pin_order"];
		}

		Object.keys(values).forEach(function(key, index) {
			var element = $('#' + key);

			if (key == "digits_on") {
				values[key] = values[key]/1000;
			}

			var elType = element.attr('type');
			if (elType == "checkbox") {
				element.prop("checked", this[key]);
				element.flipswitch("refresh");
			} else if (elType == "radio") {
				element.prop("checked", true);
				element.checkboxradio("refresh");
			} else if (typeof elType == 'undefined') {
				var radioEl = $("input:radio[name='" + key + "'][value='" + this[key] + "']");
				if (typeof radioEl != undefined && radioEl.prop('type') == 'radio') {
					radioEl.prop('checked', true);
					radioEl.checkboxradio("refresh");
				} else {
					element.html(this[key]);
				}
			} else {
				element.val(this[key]);
				if (elType == "number") {
					try {
						element.slider("refresh");
					} catch (ex) {}
				} else if (elType == 'picklist') {
					element.selectmenu("refresh");
				}
			}

			if (key == "hue" || key == "saturation" || key == "led_scale") {
				HilightColor();
			}
		}, values);
		serverSetting = false;
	}

	function updateStatus(msg) {
		$("#status").html(msg);
	}

	function url(s) {
	    var l = window.location;
	    return ((l.protocol === "https:") ? "wss://" : "ws://") + l.host + s;
	}

	function getElementValue(element) {
		element = $(element);
		var elType = element.attr('type');
		if (elType == "checkbox") {
			return element.prop("checked");
		} else {
			return element.val();
		}
	}

	var pageMap = {};

	function getPageId(pageName) {
		return pageMap[pageName];
	}

	function elementBlur(element, value) {
		if (serverSetting) {
			return;
		}
		var pageId = getPageId($(".ui-page-active").attr("id"));
		var value = value === undefined ? getElementValue(element) : value;
		var elType = $(element).attr('type');
		var name = element.id;

		if (elType == "radio") {
		    name = $(element).attr('name');
		}

		if (element.id == "digits_on") {
			value *= 1000;
		}
		var msg = '9:'+pageId+':'+name+':'+value;
		safeSend(msg);
	}

	function elementChange(element, value) {
		elementBlur(element, value);
	}

	function hsv_to_hsl(h, s, v) {
	    // both hsv and hsl values are in [0, 1]
	    var l = (2 - s) * v / 2;

	    if (l != 0) {
	        if (l == 1) {
	            s = 0
	        } else if (l < 0.5) {
	            s = s * v / (l * 2)
	        } else {
	            s = s * v / (2 - l * 2)
	        }
	    }

	    return [h, s, l]
	}

	function HilightColor() {
		var hSlider = $("#hue");
		var h = getElementValue(hSlider);
		var sSlider = $("#saturation");
		var s = getElementValue(sSlider);
		var vSlider = $("#led_scale");
		var v = getElementValue(vSlider);

		var color = "hsla(" + (h * 360 / 255 | 0) + ",100%," + (100 - s * 50 / 255 | 0) + "%," + v / 255 + ")";
		$("#color-overlay").css("background-color", color);
	}

	var presetFrom='';

	function presetsMenu(fromPage) {
		presetFrom = fromPage;
		$.mobile.changePage('presets.html', { transition: "slidedown"});
	}

	function closePresetsMenu() {
		$.mobile.changePage(presetFrom, { transition: "slideup"});
	}

	function editPresetNames() {
		$.mobile.changePage('preset_names.html', { transition: "flip"});
	}

	function closePresetNames() {
		$.mobile.changePage('presets.html', { transition: "flip"});
	}

	function initializeMenu(values) {
		var htmlString = '<ul id="menuList" data-role="listview" data-inset="true">';
		pageMap = {};

		for (var i = 0; i < values.length; i++) {
			var obj = values[i];
			var key = Object.keys(obj)[0];
			if (!obj[key].noNav) {
				htmlString += '<li><a data-rel="close" href="' + obj[key].url + '" pageId="' + obj[key].title + '">' + obj[key].title + '</a></li>';
			}
			pageMap[obj[key].title] = key;
		}

		htmlString += '</ul>';
		$("#menuList").replaceWith(htmlString);
		$("div[data-role='panel']").panel().enhanceWithin();
		if (values.length > 0) {
			var obj = values[0];
			var key = Object.keys(obj)[0];
			$.mobile.changePage(obj[key].url);
		}
	}

	function pageRefresh(activePage){
		if (typeof activePage != 'undefined') {
			safeSend(getPageId(activePage) + ':');
		}
	} ;

	function getMenu() {
		safeSend("0:");
	}

	var ws;

	ws = new WebSocket(url(":81/ws"));

	// subscribe to visibility change events
	document.addEventListener('visibilitychange', function() {
	    // fires when app transitions from prerender, user returns to the app / tab.
	    if (document.visibilityState == 'visible') {
	    	if (!ws || !(ws.readyState == WebSocket.OPEN || ws.readyState == WebSocket.CONNECTING)) {
	    		ws = new WebSocket(url(":81/ws"));
	    	}
	    }
	});

	ws.onopen = function(event) {
		try {
			getMenu();
		} catch (e) {
			(console.error || console.log).call(console, e.stack || e);
		}
	}

	ws.onmessage= function(event) {
	  var msg = JSON.parse(event.data);

	  switch(msg.type) {
	    case "sv.update":
	    case "sv.init.ups":	// Received initialization object
	    case "sv.init.clock":	// Received initialization object
	    case "sv.init.leds":	// Received initialization object
	    case "sv.init.extra":	// Received initialization object
	    case "sv.init.sync":	// Received initialization object
	    case "sv.init.presets":	// Received initialization object
	    case "sv.init.preset_names":	// Received initialization object
	    case "sv.init.info":	// Received initialization object
	    	console.log(msg.type);
	    	updateElements(msg.value);
	    	break;

	    case "sv.status":
	    	updateStatus(msg.value);
	    	break;

	    case "sv.init.menu":
	    	initializeMenu(msg.value);
	    	break;
	  }
	};

	function safeSend(msg) {
		console.log(msg);
		try {
			ws.send(msg);
		} catch (e) {
			console.log(e.stack || e);
		}
	}

	function resetList(order) {
		var order = order || "0123456789ab";

		for (var i=0; i<order.length; i++) {
			$('#pin_order [id=' + order[i] + ']')
				.remove()
				.appendTo($('#pin_order'));
		}

    	elementBlur($('#pin_order')[0], order);
	}

	$(document).ready(function () {
		$(document).on('pagecontainerchange', function(event, ui) {
		    var current = ui.toPage[0].id;
			pageRefresh(current);
		    // Remove active class from nav buttons
		    $("#menuList a.ui-btn-active").removeClass("ui-btn-active");
		    // Add active class to current nav button
		    $("#menuList a").each(function() {
		        var href = $(this).attr("pageId");
		        if (href.indexOf(current, href.length - current.length) !== -1) {
		            $(this).addClass("ui-btn-active");
		        }
		    });

		});
	});

	$(document).on("pagecontainerchange", function() {
	});

	$(document).on("pagecreate", function() {
		console.log("pagecreate");
		$.fn.roundSlider.prototype._invertRange = true;
		$("#on_range").roundSlider({
			  sliderType: "range",
			  //showTooltip: false,
			  radius: 60,
			  width: 20,
			  min: 0,
			  max: 24,
			  step: 1,
			  value: "8,22",
			  startAngle: 0,
			  endAngle: "+360",
			  handleSize: "+8",

			  change: function(e) {
				if (serverSetting) {
					return;
				}

				var values = e.value.split(',');
				var pageId = getPageId($(".ui-page-active").attr("id"));
				var msg = '9:'+pageId+':display_on:'+values[0];
				safeSend(msg);
				msg = '9:'+pageId+':display_off:'+values[1];
				safeSend(msg);
			  }
			});

		$("#digit").roundSlider({
			  sliderType: "default",
			  //showTooltip: false,
			  animation: false,
			  radius: 60,
			  width: 20,
			  min: 0,
			  max: 11,
			  step: 1,
			  value: "0",
			  startAngle: 90,
			  endAngle: 54,
			  handleSize: "+8",

			  change: function(e) {
					if (serverSetting) {
						return;
					}

					var pageId = getPageId($(".ui-page-active").attr("id"));
					var msg = '9:'+pageId+':digit:'+e.value;
					safeSend(msg);
				  },

		  drag: function(e) {
				if (serverSetting) {
					return;
				}

				var pageId = getPageId($(".ui-page-active").attr("id"));
				var msg = '9:'+pageId+':digit:'+e.value;
				safeSend(msg);
			  }
		});

	    $( "#pin_order" ).sortable();
	    $( "#pin_order" ).disableSelection();
	    <!-- Refresh list to the end of sort to have a correct display -->
	    $( "#pin_order" ).on( "sortstop", function(event, ui) {
	    	$(this).listview('refresh');
	    });
	    $( "#pin_order" ).on( "sortupdate", function( event, ui ) {
	    	var sortedIDs = $(this).sortable( "toArray" ).join('');

	    	elementBlur(this, sortedIDs);
	    } );

		console.log("end_pagecreate");
	});

	$(function () {
        $("div[data-role='panel']").panel().enhanceWithin();
    });

</script>
</head>
   <body>
	<div data-role="panel" id="mainMenu" data-position="left" data-display="overlay" data-theme="b">
		<div data-role="header"><h1>Navigation</h1></div>
		<ul id="menuList" data-role="listview" data-inset="true"></ul>
	</div>
	<div data-role="page" id="clock">
		<div data-role="header" data-position="fixed">
			<h1>Davidmpye.com VFD Clock</h1>
		</div>
        <div data-role="content" id="logo">
        </div>
	</div>
</body>
</html>
